name: buildisis

on:
  pull_request:
  workflow_dispatch:
    inputs:
      BUILD_TITLE:
        description: 'âœ¨ è‡ªå®šä¹‰æ„å»ºæ ‡é¢˜'
        required: false
      KERNEL_TREE:
        description: 'ğŸŒ³ å†…æ ¸æºç ä»“åº“åœ°å€'
        default: 'https://github.com/SunOS-Project/android_kernel_oneplus_sm8650/'
        required: true
      KERNEL_TREE_BRANCH:
        description: 'ğŸŒ¿ å†…æ ¸æºç åˆ†æ”¯'
        required: true
        default: 'varuna'
      BUILD_CONFIG:
        description: 'æ„å»ºé…ç½®ä¿¡æ¯'
        default: 'vendor/oplus/pineapple_GKI.config'
        required: true
      KERNELSU_OPTION:
        description: 'âš™ï¸ KernelSU å®‰è£…é€‰é¡¹ (1: next, 2: next-susfs, 3: ä¸å®‰è£…)'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'

jobs:
  build:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-latest
    environment: Telegram
    permissions:
      contents: write
    steps:
    - name: ğŸ“ æ˜¾ç¤ºç”¨æˆ·è¾“å…¥å‚æ•°
      run: |
        echo "::group::ğŸ“‹ ç”¨æˆ·ç¯å¢ƒå˜é‡"
        echo "è‡ªå®šä¹‰æ„å»ºæ ‡é¢˜: ${{ github.event.inputs.BUILD_TITLE }}"
        echo "å†…æ ¸æºç : ${{ github.event.inputs.KERNEL_TREE }}/tree/${{ github.event.inputs.KERNEL_TREE_BRANCH }}"
        echo "è®¾å¤‡ä»£å·: ${{ github.event.inputs.CODENAME }}"
        echo "ä¸Šä¼ åˆ° Release: ${{ github.event.inputs.UPLOAD_TO_RELEASE }}"
        echo "æ„å»ºå¼€å§‹é€šçŸ¥: ${{ github.event.inputs.NOTIFY_START }}"
        echo "æ„å»ºæˆåŠŸé€šçŸ¥: ${{ github.event.inputs.NOTIFY_SUCCESS }}"
        echo "Telegram èŠå¤© ID: ${{ github.event.inputs.TELEGRAM_CHAT_ID || secrets.TELEGRAM_CHAT_ID }}"
        echo "KernelSU é€‰é¡¹: ${{ github.event.inputs.KERNELSU_OPTION }}"
        echo "::endgroup::"

    - name: ğŸ“… ç”Ÿæˆæ„å»ºæ—¥æœŸ
      id: build_date
      run: |
        build_date=$(date +"%Y%m%d")  
        echo "build_date=$build_date" >> $GITHUB_OUTPUT

    - name: ğŸ› ï¸ åˆå§‹åŒ–å·¥ä½œåŒº
      run: |
        mkdir workspace
        cd workspace
        echo "workspace-folder=$(pwd)" >> $GITHUB_OUTPUT
        echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT
        echo "build_title=${{ github.event.inputs.BUILD_TITLE || github.event.inputs.CODENAME }}" >> $GITHUB_OUTPUT
      id: workspace

    - name: âš™ï¸ å‡†å¤‡æ„å»ºç¯å¢ƒ
      run: |
        sudo apt update -y
        sudo apt install -y flex bison libncurses-dev libssl-dev bc build-essential git ccache binutils-aarch64-linux-gnu aria2
        mkdir -p $HOME/tc
        cd $HOME/tc
        aria2x -x10 https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r547379.tar.gz -o clang.tar.gz
        mkdir clang
        tar -xf clang.tar.gz -C clang
        echo "tools-folder=$HOME/tc/clang" >> $GITHUB_OUTPUT

    - name: ğŸ“¥ å…‹éš†å†…æ ¸æºç 
      run: |
        git clone --depth=1 ${{ github.event.inputs.KERNEL_TREE }} -b ${{ github.event.inputs.KERNEL_TREE_BRANCH }} kernel_tree
        echo "kernel-folder=$(pwd)/kernel_tree" >> $GITHUB_OUTPUT
      working-directory: ${{ steps.workspace.outputs.workspace-folder }}
      id: kernel

    - name: ğŸ”¨ ç¼–è¯‘å†…æ ¸
      run: |
        # æ¸…ç†ç°æœ‰ KernelSU ç›®å½•
        rm -rf KernelSU-Next

        # æ ¹æ®é€‰é¡¹é…ç½® KernelSU
        if [[ "${{ github.event.inputs.KERNELSU_OPTION }}" == '1' ]]; then
          echo "âš™ï¸ ä½¿ç”¨ KernelSU Next é…ç½®è„šæœ¬..."
          curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh" | bash -s next
        elif [[ "${{ github.event.inputs.KERNELSU_OPTION }}" == '2' ]]; then
          echo "âš™ï¸ ä½¿ç”¨ KernelSU Next-SUSFS é…ç½®è„šæœ¬..."
          curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next-susfs/kernel/setup.sh" | bash -s next-susfs
        elif [[ "${{ github.event.inputs.KERNELSU_OPTION }}" == '3' ]]; then
          echo "â­ï¸ è·³è¿‡ KernelSU é…ç½®..."
        else
          echo "âŒ æ— æ•ˆçš„ KernelSU é€‰é¡¹!"
          exit 1
        fi

        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        export PATH="$HOME/tc/clang/bin:$PATH"
        export LD_LIBRARY_PATH=${HOME}/tc/clang/lib64:$LD_LIBRARY_PATH
        export KBUILD_COMPILER_STRING=$($HOME/tc/clang/bin/clang --version | head -n 1 | perl -pe 's/\(http.*?\)//gs' | sed -e 's/  */ /g' -e 's/[[:space:]]*$//')
        export KBUILD_LINKER_STRING=$($HOME/tc/clang/bin/ld.lld --version | head -n 1 | perl -pe 's/\(http.*?\)//gs' | sed -e 's/  */ /g' -e 's/[[:space:]]*$//' | sed 's/(compatible with [^)]*)//')

        # å‡†å¤‡æ„å»ºå‚æ•°
        DATE=$(date '+%Y%m%d-%H%M')
        OUT_DIR=out/
        VERSION="agmad-isis-PERIDOT-${DATE}"

        if [[ -z "${KEBABS}" ]]; then
            COUNT="$(grep -c '^processor' /proc/cpuinfo)"
            export KEBABS="$COUNT"
        fi

        echo "ğŸ’» å¹¶è¡Œç¼–è¯‘ä»»åŠ¡æ•°: ${KEBABS}"

        ARGS="ARCH=arm64 \
        O=${OUT_DIR} \
        CC=clang \
        LD=ld.lld \
        CLANG_TRIPLE=aarch64-linux-gnu- \
        CROSS_COMPILE=aarch64-linux-gnu- \
        CROSS_COMPILE_COMPAT=arm-linux-gnueabi- \
        -j${KEBABS}"

        START=$(date +"%s")

        # å¼€å§‹ç¼–è¯‘
        echo "ğŸš€ å¼€å§‹ç¼–è¯‘å†…æ ¸..."
        make -j${KEBABS} ${ARGS} ${{ github.event.inputs.BUILD_CONFIG }}
        cd ${OUT_DIR}
        make -j${KEBABS} ${ARGS} CC="ccache clang" HOSTCC="ccache gcc" HOSTCXX="cache g++" ${{ github.event.inputs.BUILD_CONFIG }}
        cd ../
        make -j${KEBABS} ${ARGS} CC="ccache clang" HOSTCC="ccache gcc" HOSTCXX="ccache g++" 2>&1 | tee build.log

        # å®Œæˆå¤„ç†
        echo "ğŸ‰ å†…æ ¸ç¼–è¯‘å®Œæˆ"
        END=$(date +"%s")
        DIFF=$((END - START))
        
        if [ -f "out/arch/arm64/boot/Image.gz" ]; then
            echo "ğŸ“¦ æ‰“åŒ…å†…æ ¸æ–‡ä»¶..."
            git clone -q https://github.com/ahmedtohamy1/ak3 -b peridot ak3
            cp out/arch/arm64/boot/Image.gz ak3
            cd ak3
            zip -r9 "../${VERSION}.zip" * -x '*.git*' README.md *placeholder >> /dev/null
            cd ..
            rm -rf ak3
            echo "â±ï¸ è€—æ—¶: $((DIFF / 60)) åˆ† $((DIFF % 60)) ç§’"
            echo "ğŸ“ ç”Ÿæˆæ–‡ä»¶: ${VERSION}.zip"
            echo "zipname=${VERSION}.zip" >> $GITHUB_OUTPUT
        else
            echo "âŒ ç¼–è¯‘å¤±è´¥!"
            exit 1
        fi
      working-directory: ${{ steps.kernel.outputs.kernel-folder }}
      id: build

    - name: â˜ï¸ ä¸Šä¼ åˆ° Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ steps.kernel.outputs.kernel-folder }}/${{ steps.build.outputs.zipname }}
        name: ${{ github.event.inputs.CODENAME }}-${{ steps.build_date.outputs.build_date }}
        tag_name: ${{ github.event.inputs.CODENAME }}-${{ steps.build_date.outputs.build_date }}
        body: |
          <b>âœ… å†…æ ¸ç¼–è¯‘æˆåŠŸ</b>
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          <b>${{ steps.workspace.outputs.build_title }}</b>
          â±ï¸ ç¼–è¯‘è€—æ—¶: ${{ steps.build.outputs.elapsed_time }} ç§’
          
          <b>ğŸ“± è®¾å¤‡ä»£å·</b>: <code>${{ github.event.inputs.CODENAME }}</code>
          <b>ğŸŒ³ å†…æ ¸æºç </b>: ${{ github.event.inputs.KERNEL_TREE }}/tree/${{ github.event.inputs.KERNEL_TREE_BRANCH }}
          <b>ğŸ”— å·¥ä½œæµè¯¦æƒ…</b>: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      id: upload_release



